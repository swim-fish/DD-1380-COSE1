<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DD Form 1380 TCCC Êï∏‰ΩçÁ∞ΩÁ´† QR Code Á≥ªÁµ±</title>

    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icons/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">


    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/core-js/3.45.1/minified.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.21.3/umd/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cbor-x@1.6.0/dist/index.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .form-section {
            margin-bottom: 25px;
        }
        
        .form-section h3 {
            color: #4a5568;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group-justify {
            justify-content: space-between;
        }
        
        label {
            color: #718096;
            font-size: 14px;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        input, select, textarea {
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        textarea {
            min-height: 100%;
            resize: vertical;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        
        .checkbox-group input[type="checkbox"] {
            margin-right: 8px;
            width: 18px;
            height: 18px;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }
        
        button {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .output-section {
            margin-top: 30px;
            padding: 20px;
            background: #f7fafc;
            border-radius: 10px;
        }
        
        .output-section h3 {
            color: #4a5568;
            margin-bottom: 15px;
        }
        
        #qrcode {
            display: flex;
            justify-content: center;
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 10px;
        }
        
        .data-display {
            background: #2d3748;
            color: #68d391;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            word-break: break-all;
            margin: 10px 0;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            font-size: 12px;
            color: #718096;
            margin-top: 5px;
        }
        
        .injury-section {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin: 20px 0;
        }
        
        .body-diagram {
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            min-height: 200px;
            background: #f7fafc;
        }
        
        .treatment-checklist {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        /* Êñ∞Â¢ûÊîùÂΩ±Ê©üÁï´Èù¢Ê®£Âºè */
        #videoContainer {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        #video {
            width: 80%;
            max-width: 640px;
            height: auto;
            border: 2px solid white;
            background: #333;
        }
    </style>
</head>
<body>
    <div id="videoContainer" style="display: none;">
        <video id="video"></video>
        <button onclick="stopCamera()" style="margin-top: 20px; background: #e53e3e;">ÈóúÈñâÁõ∏Ê©ü</button>
    </div>

    <div class="container">
        <h1>DD Form 1380 TCCC Êï∏‰ΩçÁ∞ΩÁ´† QR Code Á≥ªÁµ±</h1>
        
        <div class="card">
            <form id="tcccForm">
                <div class="form-section" style="background: #f0f9ff; padding: 20px; border-radius: 10px; margin-bottom: 25px;">
                    <h3 style="text-align: center; color: #0369a1; margin-bottom: 15px;">Âø´ÈÄüÊìç‰Ωú</h3>
                    <div class="button-group">
                        <button type="button" onclick="startCamera()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                            üé• ÈñãÂïüÁõ∏Ê©üÊéÉÊèè
                        </button>
                        <button type="button" onclick="document.getElementById('formFileInput').click()" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
                            üìÇ ‰∏äÂÇ≥ QR Code ÂúñÁâá
                        </button>
                        <input type="file" id="formFileInput" accept="image/*" style="display: none;" onchange="handleFileSelect(event)">
                        <button type="button" onclick="loadSampleData()" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                            üìã ËºâÂÖ•ÁØÑ‰æãË≥áÊñô
                        </button>
                        <button type="button" id="check-update-btn" onclick="checkForUpdate()" style="background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);">
                            üîÑ Êõ¥Êñ∞Á®ãÂºè
                        </button>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3>Âü∫Êú¨Ë≥áË®ä Basic Information</h3>
                    <div class="form-grid">
                        <div class="form-group form-group-justify">
                            <label>ÂßìÂêç Name</label>
                            <input type="text" id="name" required>
                        </div>
                        <div class="form-group form-group-justify">
                            <label>ËªçÁ±ç/Ë∫´‰ªΩË≠â/Ë≠∑ÁÖß  Mil ID/National ID/Passport</label>
                            <input type="text" id="serviceNumber" required>
                        </div>
                        <div class="form-group form-group-justify">
                            <label>Ë°ÄÂûã Blood Type</label>
                            <select id="bloodType" required>
                                <option value="">ÈÅ∏ÊìáË°ÄÂûã</option>
                                <option value="A+">A+</option>
                                <option value="A-">A-</option>
                                <option value="B+">B+</option>
                                <option value="B-">B-</option>
                                <option value="AB+">AB+</option>
                                <option value="AB-">AB-</option>
                                <option value="O+">O+</option>
                                <option value="O-">O-</option>
                            </select>
                        </div>
                        <div class="form-group form-group-justify">
                            <label>ÈÅéÊïèÂè≤ Allergies</label>
                            <input type="text" id="allergies" placeholder="ÁÑ°ÈÅéÊïèË´ãÂ°´ NKDA">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>ÂÇ∑Âã¢Ë©ï‰º∞ Injury Assessment</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>ÂèóÂÇ∑ÊôÇÈñì Time of Injury</label>
                            <input type="datetime-local" id="injuryTime" required>
                        </div>
                        <div class="form-group">
                            <label>ÂèóÂÇ∑Ê©üÂà∂ Mechanism of Injury</label>
                            <select id="mechanism" required>
                                <option value="">ÈÅ∏Êìá</option>
                                <option value="GSW">ÊßçÂÇ∑ GSW</option>
                                <option value="IED">ÁàÜÁÇ∏ IED</option>
                                <option value="RPG">ÁÅ´ÁÆ≠ÂΩà RPG</option>
                                <option value="MVC">ËªäÁ¶ç MVC</option>
                                <option value="Fall">Â¢úËêΩ Fall</option>
                                <option value="Other">ÂÖ∂‰ªñ Other</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="injury-section">
                        <div class="form-group">
                            <label>ÂÇ∑Âã¢ÈÉ®‰Ωç Injury Location</label>
                            <div class="body-diagram">
                                <p style="color: #718096;">Ë∫´È´îÈÉ®‰ΩçÁ§∫ÊÑèÂúñ</p>
                                <div class="treatment-checklist">
                                    <div class="checkbox-group">
                                        <input type="checkbox" id="head" name="injury">
                                        <label for="head">È†≠ÈÉ® Head</label>
                                    </div>
                                    <div class="checkbox-group">
                                        <input type="checkbox" id="neck" name="injury">
                                        <label for="neck">È†∏ÈÉ® Neck</label>
                                    </div>
                                    <div class="checkbox-group">
                                        <input type="checkbox" id="chest" name="injury">
                                        <label for="chest">ËÉ∏ÈÉ® Chest</label>
                                    </div>
                                    <div class="checkbox-group">
                                        <input type="checkbox" id="abdomen" name="injury">
                                        <label for="abdomen">ËÖπÈÉ® Abdomen</label>
                                    </div>
                                    <div class="checkbox-group">
                                        <input type="checkbox" id="leftArm" name="injury">
                                        <label for="leftArm">Â∑¶ËáÇ L-Arm</label>
                                    </div>
                                    <div class="checkbox-group">
                                        <input type="checkbox" id="rightArm" name="injury">
                                        <label for="rightArm">Âè≥ËáÇ R-Arm</label>
                                    </div>
                                    <div class="checkbox-group">
                                        <input type="checkbox" id="leftLeg" name="injury">
                                        <label for="leftLeg">Â∑¶ËÖø L-Leg</label>
                                    </div>
                                    <div class="checkbox-group">
                                        <input type="checkbox" id="rightLeg" name="injury">
                                        <label for="rightLeg">Âè≥ËÖø R-Leg</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>ÂÇ∑Âã¢ÊèèËø∞ Injury Description</label>
                            <textarea id="injuryDescription" placeholder="Ë©≥Á¥∞ÊèèËø∞ÂÇ∑Âã¢..."></textarea>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>ÁîüÂëΩÂæµË±° Vital Signs</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>ËÑàÊêè Pulse (bpm)</label>
                            <input type="number" id="pulse" min="0" max="300">
                        </div>
                        <div class="form-group">
                            <label>Ë°ÄÂ£ì Blood Pressure (mmHg)</label>
                            <input type="text" id="bloodPressure" placeholder="120/80">
                        </div>
                        <div class="form-group">
                            <label>ÂëºÂê∏ Respiratory Rate (bpm)</label>
                            <input type="number" id="respRate" min="0" max="60">
                        </div>
                        <div class="form-group">
                            <label>Ë°ÄÊ∞ß SpO2 (%)</label>
                            <input type="number" id="spo2" min="0" max="100">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>Ê≤ªÁôÇÊé™ÊñΩ Treatments</h3>
                    <div class="treatment-checklist">
                        <div class="checkbox-group">
                            <input type="checkbox" id="tourniquet" name="treatment">
                            <label for="tourniquet">Ê≠¢Ë°ÄÂ∏∂ Tourniquet</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="chestSeal" name="treatment">
                            <label for="chestSeal">ËÉ∏Â∞Å Chest Seal</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="npa" name="treatment">
                            <label for="npa">ÈºªÂíΩÁÆ° NPA</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="decompress" name="treatment">
                            <label for="decompress">ËÉ∏ËÖîÊ∏õÂ£ì Needle Decompression</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="iv" name="treatment">
                            <label for="iv">ÈùúËÑàËº∏Ê∂≤ IV/IO</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="morphine" name="treatment">
                            <label for="morphine">ÂóéÂï° Morphine</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="antibiotics" name="treatment">
                            <label for="antibiotics">ÊäóÁîüÁ¥† Antibiotics</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="hypothermia" name="treatment">
                            <label for="hypothermia">‰øùÊ∫´ Hypothermia Prevention</label>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-top: 15px;">
                        <label>ÂÖ∂‰ªñÊ≤ªÁôÇ Other Treatments</label>
                        <textarea id="otherTreatments" placeholder="ÂÖ∂‰ªñÊ≤ªÁôÇÊé™ÊñΩ..."></textarea>
                    </div>
                </div>

                <div class="form-section">
                    <h3>ÂæåÈÄÅË≥áË®ä Evacuation Info</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>ÂæåÈÄÅÂÑ™ÂÖàÁ¥ö Evacuation Priority</label>
                            <select id="evacPriority" required>
                                <option value="">ÈÅ∏Êìá</option>
                                <option value="Urgent">Á∑äÊÄ• Urgent</option>
                                <option value="Priority">ÂÑ™ÂÖà Priority</option>
                                <option value="Routine">‰æãË°å Routine</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ÊïëË≠∑Âì° Medic Name</label>
                            <input type="text" id="medicName" required>
                        </div>
                    </div>
                </div>

                <div class="button-group">
                    <button type="submit">ÁîüÊàê QR Code</button>
                    <button type="button" onclick="clearForm()">Ê∏ÖÈô§Ë°®ÂñÆ</button>
                </div>
            </form>
        </div>

        <div class="card output-section" id="outputSection" style="display: none;">
            <h3>üìä ËôïÁêÜÁµêÊûú</h3>
            
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="originalSize">0</div>
                    <div class="stat-label">ÂéüÂßãÂ§ßÂ∞è (bytes)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="compressedSize">0</div>
                    <div class="stat-label">Â£ìÁ∏ÆÂæåÂ§ßÂ∞è (bytes)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="compressionRatio">0%</div>
                    <div class="stat-label">Â£ìÁ∏ÆÁéá</div>
                </div>
            </div>

            <h4 style="margin-top: 20px;">ÁµêÊßãÂåñË≥áÊñô (JSON)</h4>
            <div class="data-display" id="jsonData"></div>
            
            <h4>COSE Sign1 Á∞ΩÁ´†Ë≥áÊñô (Base64URL)</h4>
            <div class="data-display" id="signedData"></div>
            
            <h4>Base45 Á∑®Á¢º</h4>
            <div class="data-display" id="base45Data"></div>
            
            <h4>QR Code</h4>
            <div id="qrcode"></div>
            
            <div class="button-group">
                <button onclick="downloadQRCode()">‰∏ãËºâ QR Code</button>
                <button onclick="verifyData()">È©óË≠âÁ∞ΩÁ´†</button>
            </div>
        </div>

        <div class="card" id="scanResult" style="display: none; margin-top: 20px;">
             <div id="decodedData"></div>
        </div>
    </div>

    </div> <div id="update-notification" style="display: none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: #2d3748; color: white; padding: 15px 25px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 1000; align-items: center;">
        <span style="margin-right: 20px;">ÊúâÊñ∞ÁâàÊú¨ÂèØÁî®ÔºÅ</span>
        <button id="update-button" style="background: #667eea; border: none; color: white; padding: 8px 15px; border-radius: 5px; cursor: pointer;">Á´ãÂç≥Êõ¥Êñ∞</button>
    </div>

    <div id="version-display" style="position: fixed; bottom: 5px; right: 10px; font-size: 12px; color: rgba(255, 255, 255, 0.5); z-index: 1001;">
        Loading version...
    </div>

    <script>
        // --- START: QR Code ÊéÉÊèèÁõ∏ÈóúÂáΩÂºè (‰øùÊåÅ‰∏çËÆä) ---
        let codeReader = null; 

        async function startCamera() {
            try {
                codeReader = new ZXing.BrowserMultiFormatReader();
                const videoInputDevices = await codeReader.listVideoInputDevices();
                
                if (videoInputDevices.length <= 0) throw new Error("Êâæ‰∏çÂà∞ÊîùÂΩ±Ê©üË£ùÁΩÆ");

                const selectedDeviceId = videoInputDevices[0].deviceId;
                document.getElementById('videoContainer').style.display = 'flex';

                codeReader.decodeFromVideoDevice(selectedDeviceId, 'video', (result, err) => {
                    if (result) {
                        console.log("ÊâæÂà∞ QR Code:", result.text);
                        processQRCode(result.text);
                        stopCamera();
                    }
                    if (err && !(err instanceof ZXing.NotFoundException)) {
                        console.error("Ëß£Á¢ºÈåØË™§:", err);
                        alert('ÊéÉÊèèÁôºÁîüÈåØË™§: ' + err);
                        stopCamera();
                    }
                });
            } catch (error) {
                alert('ÁÑ°Ê≥ïÂïüÂãïÁõ∏Ê©üÔºö' + error.message);
                console.error('Camera error:', error);
                stopCamera();
            }
        }

        function stopCamera() {
            if (codeReader) {
                codeReader.reset();
                codeReader = null;
            }
            document.getElementById('videoContainer').style.display = 'none';
        }

        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            try {
                const codeReaderForFile = new ZXing.BrowserMultiFormatReader();
                const imageUrl = URL.createObjectURL(file);
                const result = await codeReaderForFile.decodeFromImageUrl(imageUrl);
                processQRCode(result.getText());
                URL.revokeObjectURL(imageUrl);
            } catch (error) {
                alert('ÁÑ°Ê≥ïËÆÄÂèñ QR CodeÔºö' + error.message);
                console.error('Scan error:', error);
            } finally {
                event.target.value = null;
            }
        }
        // --- END: QR Code ÊéÉÊèèÁõ∏ÈóúÂáΩÂºè ---

        // --- START: Web Crypto and COSE Sign1 - PURE BINARY FLOW ---

        // ËºîÂä©ÂáΩÂºèÔºöString to ArrayBuffer
        function str2ab(str) {
            return new TextEncoder().encode(str);
        }

        // ÂèñÂæóÊàñÁî¢ÁîüÊñ∞ÁöÑÈáëÈë∞Â∞ç (‰øùÊåÅ‰∏çËÆä)
        async function getOrGenerateKeys() {
            const storedKeys = JSON.parse(sessionStorage.getItem('tcccKeys'));
            if (storedKeys) {
                const privateKey = await crypto.subtle.importKey("jwk", storedKeys.privateKey, { name: "ECDSA", namedCurve: "P-256" }, true, ["sign"]);
                const publicKey = await crypto.subtle.importKey("jwk", storedKeys.publicKey, { name: "ECDSA", namedCurve: "P-256" }, true, ["verify"]);
                return { privateKey, publicKey };
            }
            const keyPair = await crypto.subtle.generateKey({ name: "ECDSA", namedCurve: "P-256" }, true, ["sign", "verify"]);
            const exportedPrivateKey = await crypto.subtle.exportKey("jwk", keyPair.privateKey);
            const exportedPublicKey = await crypto.subtle.exportKey("jwk", keyPair.publicKey);
            sessionStorage.setItem('tcccKeys', JSON.stringify({
                privateKey: exportedPrivateKey,
                publicKey: exportedPublicKey
            }));
            console.log("New key pair generated and stored in sessionStorage.");
            return keyPair;
        }

        // [Êñ∞Áâà] Âª∫Á´ã COSE Sign1 Á∞ΩÁ´†ÔºåÂõûÂÇ≥Á¥î‰∫åÈÄ≤‰Ωç Uint8Array
        async function createCOSESign1(payload) {
            const { privateKey } = await getOrGenerateKeys();
            
            const protectedHeader = { alg: -7, kid: "TCCC-2025-001" }; // ES256
            const protectedHeaderBytes = str2ab(JSON.stringify(protectedHeader));
            const payloadBytes = CBOR.encode(payload);

            const sigStructure = new Uint8Array([
                ...str2ab('Signature1'),
                ...protectedHeaderBytes,
                ...payloadBytes
            ]);

            const signature = await crypto.subtle.sign(
                { name: "ECDSA", hash: { name: "SHA-256" } },
                privateKey,
                sigStructure
            );
            
            // Âª∫Á´ã COSE_Sign1 ÁµêÊßã: ‰∏ÄÂÄãÂåÖÂê´4ÂÄãÂÖÉÁ¥†ÁöÑ CBOR Èô£Âàó
            // [ protected_header, unprotected_header, payload, signature ]
            const coseSign1Array = [
                protectedHeaderBytes,
                {}, // Á©∫ÁöÑ unprotected header
                payloadBytes,
                new Uint8Array(signature) // signature ÊòØ ArrayBufferÔºåÈúÄËΩâÁÇ∫ Uint8Array
            ];

            // Â∞áÊ≠§ÁµêÊßãÁî® CBOR Á∑®Á¢ºÊàêÊúÄÁµÇÁöÑ Uint8Array
            return CBOR.encode(coseSign1Array);
        }

        // [Êñ∞Áâà] Áç®Á´ãÁöÑÁ∞ΩÁ´†È©óË≠âËºîÂä©ÂáΩÂºè
        async function verifySignature(publicKey, protectedHeaderBytes, payloadBytes, signatureBytes) {
            const sigStructure = new Uint8Array([
                ...str2ab('Signature1'),
                ...protectedHeaderBytes,
                ...payloadBytes
            ]);

            return await crypto.subtle.verify(
                { name: "ECDSA", hash: { name: "SHA-256" } },
                publicKey,
                signatureBytes,
                sigStructure
            );
        }
        // --- END: Web Crypto and COSE Sign1 ---

        // --- Base45 and Form Logic (Â§ßÈÉ®ÂàÜ‰∏çËÆä) ---
        const BASE45_ALPHABET = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ $%*+-./:";
        function base45Encode(buffer) {
            const bytes = new Uint8Array(buffer);
            let result = '';
            for (let i = 0; i < bytes.length; i += 2) {
                if (i + 1 < bytes.length) {
                    const value = bytes[i] + bytes[i + 1] * 256;
                    result += BASE45_ALPHABET[value % 45] + BASE45_ALPHABET[Math.floor(value / 45) % 45] + BASE45_ALPHABET[Math.floor(value / (45 * 45))];
                } else {
                    const value = bytes[i];
                    result += BASE45_ALPHABET[value % 45] + BASE45_ALPHABET[Math.floor(value / 45)];
                }
            }
            return result;
        }
        function base45Decode(str) {
            const result = [];
            for (let i = 0; i < str.length; i += 3) {
                if (i + 2 < str.length) {
                    const value = BASE45_ALPHABET.indexOf(str[i]) + BASE45_ALPHABET.indexOf(str[i + 1]) * 45 + BASE45_ALPHABET.indexOf(str[i + 2]) * 45 * 45;
                    result.push(value % 256, Math.floor(value / 256));
                } else if (i + 1 < str.length) {
                    const value = BASE45_ALPHABET.indexOf(str[i]) + BASE45_ALPHABET.indexOf(str[i + 1]) * 45;
                    result.push(value);
                }
            }
            return new Uint8Array(result);
        }
        function collectFormData() {
            const injuries = Array.from(document.querySelectorAll('input[name="injury"]:checked')).map(cb => cb.id);
            const treatments = Array.from(document.querySelectorAll('input[name="treatment"]:checked')).map(cb => cb.id);
            return {
                version: "1.0",
                timestamp: new Date().toISOString(),
                patient: { name: document.getElementById('name').value, serviceNumber: document.getElementById('serviceNumber').value, bloodType: document.getElementById('bloodType').value, allergies: document.getElementById('allergies').value || "NKDA" },
                injury: { time: document.getElementById('injuryTime').value, mechanism: document.getElementById('mechanism').value, locations: injuries, description: document.getElementById('injuryDescription').value },
                vitals: { pulse: parseInt(document.getElementById('pulse').value) || null, bloodPressure: document.getElementById('bloodPressure').value || null, respRate: parseInt(document.getElementById('respRate').value) || null, spo2: parseInt(document.getElementById('spo2').value) || null },
                treatments: { applied: treatments, other: document.getElementById('otherTreatments').value },
                evacuation: { priority: document.getElementById('evacPriority').value, medicName: document.getElementById('medicName').value }
            };
        }
        
        // [Êñ∞Áâà] Ë°®ÂñÆÊèê‰∫§ÊµÅÁ®ã
        document.getElementById('tcccForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const tcccData = collectFormData();
            const jsonString = JSON.stringify(tcccData);
            const originalSize = new TextEncoder().encode(jsonString).length;
            
            // 1. Âª∫Á´ãÁ¥î‰∫åÈÄ≤‰ΩçÁöÑ COSE_Sign1 Áâ©‰ª∂
            const coseSign1Bytes = await createCOSESign1(tcccData);
            
            // 2. Áõ¥Êé•Â£ìÁ∏ÆÊ≠§‰∫åÈÄ≤‰ΩçÁâ©‰ª∂
            const compressed = pako.deflate(coseSign1Bytes);
            const compressedSize = compressed.length;
            
            // 3. Base45 Á∑®Á¢º
            const base45Encoded = base45Encode(compressed);
            const qrData = "TC1:" + base45Encoded;
            
            // --- Êõ¥Êñ∞È°ØÁ§∫ ---
            document.getElementById('outputSection').style.display = 'block';
            document.getElementById('jsonData').textContent = jsonString;
            // Âõ†ÁÇ∫ÊòØ‰∫åÈÄ≤‰ΩçÔºåsignedData ÂçÄÂ°äÈ°ØÁ§∫ÊèêÁ§∫Ë®äÊÅØ
            document.getElementById('signedData').textContent = `[Binary COSE_Sign1 Data - ${coseSign1Bytes.byteLength} bytes]`;
            document.getElementById('base45Data').textContent = qrData;
            document.getElementById('originalSize').textContent = originalSize;
            document.getElementById('compressedSize').textContent = compressedSize;
            document.getElementById('compressionRatio').textContent = Math.round((1 - compressedSize / originalSize) * 100) + '%';
            
            document.getElementById('qrcode').innerHTML = '';
            new QRCode(document.getElementById('qrcode'), {
                text: qrData, width: 300, height: 300,
                colorDark: "#000000", colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.M,
                margin: 4
            });
            document.getElementById('outputSection').scrollIntoView({ behavior: 'smooth' });
        });
        
        function clearForm() {
            if (confirm('Á¢∫ÂÆöË¶ÅÊ∏ÖÈô§ÊâÄÊúâË≥áÊñôÂóéÔºü')) {
                document.getElementById('tcccForm').reset();
                document.getElementById('outputSection').style.display = 'none';
            }
        }
        
        function downloadQRCode() {
            const canvas = document.querySelector('#qrcode canvas');
            if (canvas) {
                const link = document.createElement('a');
                link.download = 'TCCC_QRCode_' + new Date().getTime() + '.png';
                link.href = canvas.toDataURL();
                link.click();
            }
        }
        
        // [Êñ∞Áâà] È©óË≠âË≥áÊñôÊµÅÁ®ã
        async function verifyData() {
            const base45Data = document.getElementById('base45Data').textContent;
            try {
                // 1. Base45 Ëß£Á¢º -> 2. Zlib Ëß£Â£ìÁ∏Æ -> ÂæóÂà∞Á¥î‰∫åÈÄ≤‰Ωç COSE_Sign1 Áâ©‰ª∂
                const decompressedBytes = pako.inflate(base45Decode(base45Data.replace('TC1:', '')));
                
                // 3. CBOR Ëß£Á¢º COSE_Sign1 ÁµêÊßã
                const coseSign1Array = CBOR.decode(decompressedBytes);
                const [protectedHeaderBytes, , payloadBytes, signatureBytes] = coseSign1Array;
                
                // 4. È©óË≠âÁ∞ΩÁ´†
                const { publicKey } = await getOrGenerateKeys();
                const isValid = await verifySignature(publicKey, protectedHeaderBytes, payloadBytes, signatureBytes);

                if (isValid) {
                    // 5. CBOR Ëß£Á¢º payload ÂèñÂæóÂéüÂßãË≥áÊñô
                    const payload = CBOR.decode(payloadBytes);
                    alert('‚úÖ Á∞ΩÁ´†È©óË≠âÊàêÂäüÔºÅ\n\nË≥áÊñôÂÆåÊï¥ÊÄßÂ∑≤Á¢∫Ë™ç„ÄÇ');
                    console.log('È©óË≠âÁöÑË≥áÊñô:', payload);
                } else {
                    alert('‚ùå Á∞ΩÁ´†È©óË≠âÂ§±ÊïóÔºÅ\n\nSignature is invalid.');
                }
            } catch (error) {
                alert('‚ùå Ë≥áÊñôËß£ÊûêÂ§±ÊïóÔºÅ\n\n' + error.message);
                console.error(error);
            }
        }
        
        // [Êñ∞Áâà] ËôïÁêÜ QR Code ÊµÅÁ®ã
        async function processQRCode(qrData) {
            try {
                if (!qrData.startsWith('TC1:')) throw new Error('ÈÄô‰∏çÊòØÊúâÊïàÁöÑ TCCC QR Code');
                
                const decompressedBytes = pako.inflate(base45Decode(qrData.replace('TC1:', '')));
                const coseSign1Array = CBOR.decode(decompressedBytes);
                const [protectedHeaderBytes, , payloadBytes, signatureBytes] = coseSign1Array;

                const { publicKey } = await getOrGenerateKeys();
                const isValid = await verifySignature(publicKey, protectedHeaderBytes, payloadBytes, signatureBytes);

                if (isValid) {
                    const payload = CBOR.decode(payloadBytes);
                    alert('‚úÖ QR Code ËÆÄÂèñËàáÈ©óË≠âÊàêÂäüÔºÅ');
                    displayDecodedData(payload);
                    fillFormFromData(payload);
                } else {
                    throw new Error('Á∞ΩÁ´†È©óË≠âÂ§±Êïó');
                }
            } catch (error) {
                alert('QR Code Ëß£ÊûêÂ§±ÊïóÔºö' + error.message);
                console.error('Process error:', error);
            }
        }

        // --- Display and Form Fill Logic (‰øùÊåÅ‰∏çËÆä) ---
        function displayDecodedData(data) {
            const scanResult = document.getElementById('scanResult');
            const decodedData = document.getElementById('decodedData');
            let html = `<div class="patient-card"><div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;"><h3 style="margin: 0;">ÊéÉÊèèÁµêÊûúÔºöÂÇ∑ÊÇ£Ë≥áË®ä</h3><span style="padding: 5px 10px; border-radius: 15px; color: white; background-color: ${data.evacuation.priority.toLowerCase() === 'urgent' ? '#e53e3e' : '#f59e0b'};">${data.evacuation.priority}</span></div><p><strong>ÂßìÂêç:</strong> ${data.patient.name} | <strong>ËªçÁ±ç/Ë∫´‰ªΩË≠â/Ë≠∑ÁÖß:</strong> ${data.patient.serviceNumber}</p><p><strong>Ë°ÄÂûã:</strong> ${data.patient.bloodType} | <strong>ÈÅéÊïèÂè≤:</strong> ${data.patient.allergies}</p><hr style="margin: 10px 0;"><p><strong>ÂèóÂÇ∑ÊôÇÈñì:</strong> ${new Date(data.injury.time).toLocaleString('zh-TW', { timeZone: 'Asia/Taipei' })}</p><p><strong>ÂèóÂÇ∑Ê©üÂà∂:</strong> ${data.injury.mechanism}</p><p><strong>ÂèóÂÇ∑ÈÉ®‰Ωç:</strong> ${data.injury.locations.join(', ')}</p><p><strong>Â∑≤ÂØ¶ÊñΩÊ≤ªÁôÇ:</strong> ${data.treatments.applied.join(', ') || 'ÁÑ°'}</p><hr style="margin: 10px 0;"><p><strong>ÊïëË≠∑Âì°:</strong> ${data.evacuation.medicName} | <strong>Ë®òÈåÑÊôÇÈñì:</strong> ${new Date(data.timestamp).toLocaleString('zh-TW', { timeZone: 'Asia/Taipei' })}</p></div>`;
            decodedData.innerHTML = html;
            scanResult.style.display = 'block';
            scanResult.scrollIntoView({ behavior: 'smooth' });
        }
        function fillFormFromData(data) {
            document.getElementById('name').value = data.patient.name || '';
            document.getElementById('serviceNumber').value = data.patient.serviceNumber || '';
            document.getElementById('bloodType').value = data.patient.bloodType || '';
            document.getElementById('allergies').value = data.patient.allergies || '';
            document.getElementById('injuryTime').value = data.injury.time || '';
            document.getElementById('mechanism').value = data.injury.mechanism || '';
            document.getElementById('injuryDescription').value = data.injury.description || '';
            document.querySelectorAll('input[name="injury"]').forEach(cb => cb.checked = false);
            data.injury.locations.forEach(location => {
                const cb = document.getElementById(location);
                if (cb) cb.checked = true;
            });
            document.getElementById('pulse').value = data.vitals.pulse || '';
            document.getElementById('bloodPressure').value = data.vitals.bloodPressure || '';
            document.getElementById('respRate').value = data.vitals.respRate || '';
            document.getElementById('spo2').value = data.vitals.spo2 || '';
            document.querySelectorAll('input[name="treatment"]').forEach(cb => cb.checked = false);
            data.treatments.applied.forEach(treatment => {
                const cb = document.getElementById(treatment);
                if (cb) cb.checked = true;
            });
            document.getElementById('otherTreatments').value = data.treatments.other || '';
            document.getElementById('evacPriority').value = data.evacuation.priority || '';
            document.getElementById('medicName').value = data.evacuation.medicName || '';
        }
        function loadSampleData() {
            const sampleData = {
                name: 'ÁéãÂ§ßÊòé', serviceNumber: 'TW-2024-0001', bloodType: 'O+',
                allergies: 'Penicillin', injuryTime: new Date().toISOString().slice(0, 16),
                mechanism: 'IED', injuryDescription: 'Âè≥‰∏ãËÇ¢ÁàÜÁÇ∏ÂÇ∑ÔºåÂ§ßÈáèÂá∫Ë°Ä',
                pulse: '120', bloodPressure: '90/60', respRate: '24', spo2: '92',
                evacPriority: 'Urgent', medicName: 'ÊùéÈÜ´ÂÆò'
            };
            for (const key in sampleData) {
                document.getElementById(key).value = sampleData[key];
            }
            document.getElementById('rightLeg').checked = true;
            document.getElementById('tourniquet').checked = true;
            document.getElementById('iv').checked = true;
            document.getElementById('morphine').checked = true;
            alert('‚úÖ ÁØÑ‰æãË≥áÊñôÂ∑≤ËºâÂÖ•ÔºÅÊÇ®ÂèØ‰ª•Áõ¥Êé•ÁîüÊàê QR Code Ê∏¨Ë©¶„ÄÇ');
        }

        // Ë®≠ÂÆöÈ†êË®≠ÊôÇÈñìÁÇ∫ÁèæÂú®
        document.getElementById('injuryTime').value = new Date(new Date().getTime() - new Date().getTimezoneOffset() * 60000).toISOString().slice(0, 16);

        // === ‰ΩøÁî®ÈÄôÊÆµÊñ∞ÁöÑ„ÄÅÂÆåÊï¥ÁöÑ Service Worker Ë®ªÂÜäËàáÊõ¥Êñ∞ÈÇèËºØ ===
        let swRegistration = null; // Áî®ÊñºÂÑ≤Â≠ò Service Worker ÁöÑË®ªÂÜäÁâ©‰ª∂
        let currentVersion = 'unknown';
        let newWorkerVersion = 'unknown';

        // È°ØÁ§∫Êõ¥Êñ∞Ê©´ÂπÖÁöÑÂáΩÂºè
        function showUpdateBanner(registration, oldVerName, newVerName) {
            const notification = document.getElementById('update-notification');
            const updateButton = document.getElementById('update-button');
            const notificationSpan = notification.querySelector('span');

            const oldVerDisplay = oldVerName.split('-').pop() || 'unknown';
            const newVerDisplay = newVerName.split('-').pop() || 'unknown';

            notificationSpan.textContent = `ÊúâÊñ∞ÁâàÊú¨ÂèØÁî®ÔºÅ(Áï∂Ââç: ${oldVerDisplay}, Êñ∞Áâà: ${newVerDisplay})`;
            notification.style.display = 'flex';

            // ÁßªÈô§ËàäÁöÑ‰∫ã‰ª∂Áõ£ËÅΩÂô®‰ª•ÈÅøÂÖçÈáçË§áË®ªÂÜä
            updateButton.onclick = null; 
            updateButton.addEventListener('click', () => {
                const waitingWorker = registration.waiting;
                if (waitingWorker) {
                    waitingWorker.postMessage({ action: 'SKIP_WAITING' });
                    notification.style.display = 'none';
                }
            }, { once: true }); // ‰ΩøÁî® once: true Á¢∫‰øù‰∫ã‰ª∂Âè™Âü∑Ë°å‰∏ÄÊ¨°
        }

        // Ê™¢Êü•Êõ¥Êñ∞ÁöÑÂáΩÂºè (Áî±ÊåâÈàïËß∏Áôº)
        async function checkForUpdate() {
            // alert('Ê≠£Âú®Ê™¢Êü•Êõ¥Êñ∞...');
            
            try {
                let registration = await navigator.serviceWorker.getRegistration();

                if (!registration) {
                    console.warn('Service Worker Â∞öÊú™Ë®ªÂÜäÊàñÂ∑≤Âç∏ËºâÔºåÂòóË©¶ÈáçÊñ∞Ë®ªÂÜä„ÄÇ');
                    registration = await navigator.serviceWorker.register('./sw.js');
                }

                // ÂòóË©¶Êõ¥Êñ∞ Service Worker
                // await registration.update();

                // ÂÜçÊ¨°Áç≤ÂèñÊúÄÊñ∞ÁöÑË®ªÂÜäÁâ©‰ª∂ÔºåÂõ†ÁÇ∫ update() ÂèØËÉΩÊúÉÊîπËÆäÂÆÉÁöÑÁãÄÊÖã
                const updatedRegistration = await navigator.serviceWorker.getRegistration();

                if (updatedRegistration && updatedRegistration.waiting) {
                    console.log("ÁôºÁèæÁ≠âÂæÖ‰∏≠ÁöÑÊñ∞ÁâàÊú¨ Service Worker„ÄÇ");
                    updatedRegistration.waiting.postMessage({ action: 'GET_VERSION', fromUpdateCheck: true });
                } else {
                    alert(`ÊÇ®ÁõÆÂâç‰ΩøÁî®ÁöÑÂ∑≤ÊòØÊúÄÊñ∞ÁâàÊú¨ (${currentVersion.split('-').pop() || 'unknown'})„ÄÇ`);
                }
            } catch (error) {
                console.error('Error during update check:', error);
                
                // --- ÁâπÊÆäËôïÁêÜ InvalidStateError ---
                if (error.name === 'InvalidStateError') {
                    console.warn('ÊçïÁç≤Âà∞ InvalidStateErrorÔºåÂèØËÉΩÁî±Êñº Service Worker ËôïÊñº‰∏çÁ©©ÂÆöÁãÄÊÖã„ÄÇ');
                    alert('Service Worker ÁãÄÊÖãÁï∞Â∏∏ÔºåÂòóË©¶Âº∑Âà∂Êõ¥Êñ∞„ÄÇÈÄôÂ∞áÈáçÊñ∞ËºâÂÖ•È†ÅÈù¢„ÄÇ');
                    
                    // Âú®Ê≠§ÊÉÖÊ≥Å‰∏ãÔºåÊàëÂÄëÂ∞áÂòóË©¶Êõ¥ÊøÄÈÄ≤Âú∞ÈáçÁΩÆ Service Worker ÁãÄÊÖã
                    // ÈÄèÈÅé window.location.reload() ‰æÜÂº∑Âà∂ÁÄèË¶ΩÂô®ÈáçÊñ∞Ê™¢Êü•ÊâÄÊúâÂÖßÂÆπ
                    // ‰∏¶Â∏åÊúõÂú®ÈáçÊñ∞ËºâÂÖ•ÊôÇÔºåService Worker ËÉΩÊ≠£Â∏∏ÂÆâË£ùÂíåÂïüÁî®
                    window.location.reload(true); // ÂÇ≥ÈÅû true ÂèÉÊï∏Ë°®Á§∫Âæû‰º∫ÊúçÂô®ÈáçÊñ∞Áç≤Âèñ
                } else {
                    alert('Ê™¢Êü•Êõ¥Êñ∞Â§±ÊïóÔºö' + error.message);
                }
            }
        }


        if ('serviceWorker' in navigator) {
            // Áõ£ËÅΩ‰æÜËá™ SW ÁöÑË®äÊÅØ (ÂåÖÂê´ÁâàÊú¨ÂõûË¶Ü)
            navigator.serviceWorker.addEventListener('message', event => {
                if (event.data && event.data.type === 'VERSION') {
                    const versionDisplayElement = document.getElementById('version-display');
                    const newVersionDisplay = event.data.version.split('-').pop() || 'unknown';
                    
                    // Â¶ÇÊûúÊòØ‰æÜËá™Êõ¥Êñ∞Ê™¢Êü•ÁöÑÂõûË¶ÜÔºå‰∏îÊúâÁ≠âÂæÖ‰∏≠ÁöÑ worker
                    if (event.data.action === 'GET_VERSION_RESPONSE_FOR_UPDATE_CHECK' && swRegistration.waiting) {
                        // ÈÄôÂÄãÁâàÊú¨ÊòØÊñ∞ worker ÁöÑÁâàÊú¨
                        newWorkerVersion = event.data.version;
                        // È°ØÁ§∫Êõ¥Êñ∞Ê©´ÂπÖÔºåÂÇ≥ÂÖ•ËàäÁâàÊú¨ÂíåÊñ∞ÁâàÊú¨
                        showUpdateBanner(swRegistration, currentVersion, newWorkerVersion);
                    } else {
                        // ÈÄôÊòØÈ†ÅÈù¢ËºâÂÖ•ÊôÇÁöÑÂàùÂßãÁâàÊú¨Êü•Ë©¢ÔºåË®≠ÂÆöÁÇ∫ currentVersion
                        currentVersion = event.data.version;
                        versionDisplayElement.textContent = `Ver: ${newVersionDisplay}`;
                    }
                }
            });

            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        swRegistration = registration;
                        console.log('Service Worker registered with scope: ', registration.scope);

                        // È¶ñÊ¨°ËºâÂÖ•ÊôÇÔºåÂ¶ÇÊûúÂ∑≤Êúâ active ÁöÑ SWÔºåÂ∞±ÂêëÂÆÉË´ãÊ±ÇÁï∂ÂâçÁâàÊú¨Ëôü
                        if (registration.active) {
                            registration.active.postMessage({ action: 'GET_VERSION' });
                        }
                        
                        // Áõ£ËÅΩÊòØÂê¶ÊúâÊñ∞ÁâàÊú¨ÂÆâË£ùÂÆåÁï¢‰∏¶ÈÄ≤ÂÖ•Á≠âÂæÖÁãÄÊÖã
                        registration.addEventListener('updatefound', () => {
                            const installingWorker = registration.installing;
                            if (installingWorker) {
                                installingWorker.addEventListener('statechange', () => {
                                    if (installingWorker.state === 'installed' && swRegistration.waiting) {
                                        // Êñ∞ worker Â∑≤ÂÆâË£ùÔºå‰ΩÜÂ∞öÊú™ÂïüÁî® (Á≠âÂæÖ‰∏≠)
                                        // ÂêëÈÄôÂÄãÊñ∞ÁöÑ waiting worker Ë´ãÊ±ÇÂÆÉÁöÑÁâàÊú¨ËôüÔºåÁÑ∂ÂæåËß∏ÁôºÊ©´ÂπÖÈ°ØÁ§∫
                                        installingWorker.postMessage({ action: 'GET_VERSION', fromUpdateCheck: true });
                                    }
                                });
                            }
                        });
                    }).catch(error => {
                        console.log('Service Worker registration failed: ', error);
                    });

                // Áõ£ËÅΩ Service Worker ÊéßÂà∂Âô®ËÆäÊõ¥‰∫ã‰ª∂
                // Áï∂Êñ∞ÁöÑ Service Worker Êé•ÁÆ°È†ÅÈù¢ÊéßÂà∂Ê¨äÊôÇËß∏Áôº
                let refreshing = false;
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    if (refreshing) return; // Èò≤Ê≠¢ÈáçË§áÈáçÊñ∞Êï¥ÁêÜ
                    refreshing = true;
                    // Áï∂Êñ∞ÁöÑ Service Worker ÊàêÁÇ∫ active ÁöÑÊéßÂà∂Âô®ÂæåÔºåÈáçÊñ∞ËºâÂÖ•È†ÅÈù¢
                    window.location.reload(); 
                });
            });
        }
    </script>

</body>
</html>