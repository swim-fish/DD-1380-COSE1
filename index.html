<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DD Form 1380 TCCC 數位簽章 QR Code 系統</title>

    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icons/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">

    <!-- 引入自訂外部 CSS (在 Bootstrap 之後) -->
    <link rel="stylesheet" href="style.css">

    <!-- 外部函式庫 (保持不變) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.1/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/core-js/3.45.1/minified.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.21.3/umd/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cbor-x@1.6.0/dist/index.min.js"></script>

</head>

<body>
    <div id="videoContainer" style="display: none;">
        <video id="video"></video>
        <button onclick="stopCamera()" style="margin-top: 20px; background: #e53e3e;">關閉相機</button>
    </div>

    <div class="container">
        <h1>DD Form 1380 TCCC 數位簽章 QR Code 系統</h1>

        <div class="card">
            <form id="tcccForm">
                <div class="form-section"
                    style="background: #f0f9ff; padding: 20px; border-radius: 10px; margin-bottom: 25px;">
                    <h3 style="text-align: center; color: #0369a1; margin-bottom: 15px;">快速操作</h3>
                    <div class="button-group">
                        <button type="button" onclick="startCamera()"
                            style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">🎥 開啟相機掃描</button>
                        <button type="button" onclick="document.getElementById('formFileInput').click()"
                            style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">📂 上傳 QR Code
                            圖片</button>
                        <input type="file" id="formFileInput" accept="image/*" style="display: none;"
                            onchange="handleFileSelect(event)">
                        <button type="button" onclick="loadSampleData()"
                            style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">📋 載入範例資料</button>
                        <button type="button" id="check-update-btn" onclick="checkForUpdate()"
                            style="background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);">🔄 更新程式</button>
                    </div>
                </div>

                <div class="form-section">
                    <h3>基本資訊 Basic Information</h3>
                    <div class="form-grid">
                        <div class="form-group form-group-justify"><label for="patientBattleRoster">戰傷編號 (Battle
                                Roster):</label><input type="text" id="patientBattleRoster" name="patientBattleRoster"
                                placeholder="輸入戰場傷患編號" required></div>
                        <div class="form-group form-group-justify"><label>姓名 Name</label><input type="text" id="name"
                                required></div>
                        <div class="form-group-wrapper">
                            <div class="form-group form-group-justify"><label for="service">軍種 SERVICE</label><input
                                    type="text" id="service" placeholder="例如：陸軍、海軍"></div>
                            <div class="form-group form-group-justify"><label for="unit">單位 UNIT</label><input
                                    type="text" id="unit" placeholder="例如：步兵101旅"></div>
                        </div>
                        <div class="form-group-wrapper">
                            <div class="form-group form-group-justify"><label>ID 末4碼 Last 4</label><input type="text"
                                    id="idLast4" required></div>
                            <div class="form-group form-group-justify"><label>血型 Blood Type</label><select
                                    id="bloodType" required>
                                    <option value="">選擇血型</option>
                                    <option value="A+">A+</option>
                                    <option value="A-">A-</option>
                                    <option value="B+">B+</option>
                                    <option value="B-">B-</option>
                                    <option value="AB+">AB+</option>
                                    <option value="AB-">AB-</option>
                                    <option value="O+">O+</option>
                                    <option value="O-">O-</option>
                                </select></div>
                        </div>
                        <div class="form-group form-group-justify"><label>過敏史 Allergies</label><input type="text"
                                id="allergies" placeholder="無過敏請填 NKDA"></div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>傷勢評估 Injury Assessment</h3>
                    <div class="form-grid">
                        <div class="form-group"><label>受傷時間 Time of Injury</label><input type="datetime-local"
                                id="injuryTime" required></div>
                        <div class="form-group"><label>受傷機制 Mechanism of Injury</label><select id="mechanism" required>
                                <option value="">選擇機制</option>
                                <option value="Artillery">砲擊 Artillery</option>
                                <option value="Burn">燒燙傷 Burn</option>
                                <option value="Fall">墜落 Fall</option>
                                <option value="Grenade">手榴彈 Grenade</option>
                                <option value="GSW">槍傷 GSW</option>
                                <option value="IED">爆炸裝置 IED</option>
                                <option value="Landmine">地雷 Landmine</option>
                                <option value="MVC">車輛事故 MVC</option>
                                <option value="RPG">火箭彈 RPG</option>
                                <option value="Other">其他 Other</option>
                            </select></div>
                    </div>

                    <div class="form-section" style="margin-top: 20px;">
                        <h4>止血帶紀錄 (Tourniquet Application)</h4>
                        <div class="tourniquet-section">
                            <div class="container text-center">
                                <div class="row">
                                    <div class="col">
                                        <div class="tq-record"><label for="tq_l_arm_type">TQ: Left Arm</label>
                                            <div class="tq-record-inputs"><input type="text" id="tq_l_arm_type"
                                                    list="tq-types" placeholder="Type"><input type="time"
                                                    id="tq_l_arm_time"></div>
                                        </div>
                                    </div>
                                    <div class="col">
                                        <div class="tq-record"><label for="tq_r_arm_type">TQ: Right Arm</label>
                                            <div class="tq-record-inputs"><input type="text" id="tq_r_arm_type"
                                                    list="tq-types" placeholder="Type"><input type="time"
                                                    id="tq_r_arm_time"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col">
                                        <div class="tq-record"><label for="tq_l_leg_type">TQ: Left Leg</label>
                                            <div class="tq-record-inputs"><input type="text" id="tq_l_leg_type"
                                                    list="tq-types" placeholder="Type"><input type="time"
                                                    id="tq_l_leg_time"></div>
                                        </div>
                                    </div>
                                    <div class="col">
                                        <div class="tq-record"><label for="tq_r_leg_type">TQ: Right Leg</label>
                                            <div class="tq-record-inputs"><input type="text" id="tq_r_leg_type"
                                                    list="tq-types" placeholder="Type"><input type="time"
                                                    id="tq_r_leg_time"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <datalist id="tq-types">
                            <option value="CAT"></option>
                            <option value="SAM"></option>
                        </datalist>
                    </div>

                    <div class="form-group" style="margin-top: 20px;"><label>傷勢描述 Injury Description</label><textarea
                            id="injuryDescription" placeholder="詳細描述傷勢..."></textarea></div>
                </div>

                <div class="form-section">
                    <h3>生命徵象 Vital Signs</h3>
                    <div class="table-responsive">
                        <table class="table table-bordered" id="vitals-table">
                            <thead>
                                <tr>
                                    <th class="vitals-label">項目</th>
                                    <!-- 時間欄位將由 JS 動態生成 -->
                                </tr>
                            </thead>
                            <tbody>
                                <!-- 資料列將由 JS 動態生成 -->
                            </tbody>
                        </table>
                    </div>
                    <div class="d-flex justify-content-center gap-2 mt-2">
                        <button type="button" class="btn btn-outline-secondary btn-sm"
                            id="add-vitals-col">新增時間欄</button>
                        <button type="button" class="btn btn-outline-danger btn-sm"
                            id="remove-vitals-col">刪除時間欄</button>
                    </div>
                </div>

                <div class="form-section">
                    <h3>治療措施 Treatments</h3>
                    <div class="container text-center">
                        <div class="row">
                            <div class="col-sm-4">
                                <div class="btn-group flex-wrap" role="group"
                                    aria-label="Treatments toggle button group">
                                    <input type="checkbox" class="btn-check" id="tourniquet" autocomplete="off"><label
                                        class="btn btn-outline-primary" for="tourniquet">止血帶 Tourniquet</label>
                                    <input type="checkbox" class="btn-check" id="chestSeal" autocomplete="off"><label
                                        class="btn btn-outline-primary" for="chestSeal">胸封 Chest Seal</label>
                                    <input type="checkbox" class="btn-check" id="npa" autocomplete="off"><label
                                        class="btn btn-outline-primary" for="npa">鼻咽管 NPA</label>
                                    <input type="checkbox" class="btn-check" id="decompress" autocomplete="off"><label
                                        class="btn btn-outline-primary" for="decompress">胸腔減壓 Needle
                                        Decompression</label>
                                    <input type="checkbox" class="btn-check" id="iv" autocomplete="off"><label
                                        class="btn btn-outline-primary" for="iv">靜脈輸液 IV/IO</label>
                                    <input type="checkbox" class="btn-check" id="morphine" autocomplete="off"><label
                                        class="btn btn-outline-primary" for="morphine">嗎啡 Morphine</label>
                                    <input type="checkbox" class="btn-check" id="antibiotics" autocomplete="off"><label
                                        class="btn btn-outline-primary" for="antibiotics">抗生素 Antibiotics</label>
                                    <input type="checkbox" class="btn-check" id="hypothermia" autocomplete="off"><label
                                        class="btn btn-outline-primary" for="hypothermia">保溫 Hypothermia
                                        Prevention</label>
                                </div>
                            </div>
                            <div class="col-sm-8">
                                <div class="form-group" style="margin-top: 15px;"><label>其他治療 Other
                                        Treatments</label><textarea id="otherTreatments"
                                        placeholder="其他治療措施..."></textarea></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>後送資訊 Evacuation Info</h3>
                    <div class="form-grid">
                        <div class="form-group"><label>後送優先級 Evacuation Priority</label><select id="evacPriority"
                                required>
                                <option value="">選擇</option>
                                <option value="Urgent">緊急 Urgent</option>
                                <option value="Priority">優先 Priority</option>
                                <option value="Routine">例行 Routine</option>
                            </select></div>
                        <div class="form-group"><label>救護員 Medic Name</label><input type="text" id="medicName" required>
                        </div>
                    </div>
                </div>

                <div class="button-group">
                    <button type="submit">生成 QR Code</button>
                    <button type="button" onclick="clearForm()">清除表單</button>
                </div>
            </form>
        </div>

        <div class="card output-section" id="outputSection" style="display: none;">
            <h3>📊 處理結果</h3>
            <div class="stats">
                <table class="table">
                    <thead>
                        <tr>
                            <th scope="col"></th>
                            <th scope="col">原始大小 (bytes)</th>
                            <th scope="col">壓縮後大小 (bytes)</th>
                            <th scope="col">最終 QR Code 大小 (bytes)</th>
                            <th scope="col">壓縮率</th>
                        </tr>
                    </thead>
                    <tbody class="table-group-divider">
                        <tr>
                            <th scope="row"></th>
                            <td>
                                <div class="stat-value" id="originalSize">0</div>
                            </td>
                            <td>
                                <div class="stat-value" id="compressedSize">0</div>
                            </td>
                            <td>
                                <div class="stat-value" id="qrDataSize">0</div>
                            </td>
                            <td>
                                <div class="stat-value" id="compressionRatio">0%</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <h4 style="margin-top: 20px;">結構化資料 (JSON)</h4>
            <div class="data-display" id="jsonData"></div>
            <h4>COSE Sign1 簽章資料 (Binary)</h4>
            <div class="data-display" id="signedData"></div>
            <h4>Base45 編碼</h4>
            <div class="data-display" id="base45Data"></div>
            <h4>QR Code</h4>
            <div id="qrcode"></div>
            <div class="button-group"><button onclick="downloadQRCode()">下載 QR Code</button><button
                    onclick="verifyData()">驗證簽章</button></div>
        </div>
        <div class="card" id="scanResult" style="display: none; margin-top: 20px;">
            <div id="decodedData"></div>
        </div>
    </div>

    <footer class="container text-center py-4 mt-4">
        <a href="https://github.com/swim-fish/DD-1380-COSE1" target="_blank" rel="noopener noreferrer"
            class="text-white-50">專案 GitHub 連結</a>
    </footer>
    <a href="#" id="back-to-top" class="btn btn-primary rounded-circle shadow" title="回到最上面">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-up"
            viewBox="0 0 16 16">
            <path fill-rule="evenodd"
                d="M8 15a.5.5 0 0 0 .5-.5V2.707l3.146 3.147a.5.5 0 0 0 .708-.708l-4-4a.5.5 0 0 0-.708 0l-4 4a.5.5 0 1 0 .708.708L7.5 2.707V14.5a.5.5 0 0 0 .5.5z" />
        </svg>
    </a>

    <div id="update-notification"
        style="display: none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: #2d3748; color: white; padding: 15px 25px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 1000; align-items: center;">
        <span style="margin-right: 20px;">有新版本可用！</span><button id="update-button"
            style="background: #667eea; border: none; color: white; padding: 8px 15px; border-radius: 5px; cursor: pointer;">立即更新</button>
    </div>
    <div id="version-display"
        style="position: fixed; bottom: 5px; right: 10px; font-size: 12px; color: rgba(255, 255, 255, 0.5); z-index: 1001;">
        Loading version...</div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
        crossorigin="anonymous"></script>
    <script src="app.js"></script>

</body>

</html>