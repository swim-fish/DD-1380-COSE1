<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DD Form 1380 TCCC æ•¸ä½ç°½ç«  QR Code ç³»çµ±</title>

    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icons/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">


    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/core-js/3.45.1/minified.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.21.3/umd/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cbor-x@1.6.0/dist/index.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .form-section {
            margin-bottom: 25px;
        }
        
        .form-section h3 {
            color: #4a5568;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group-justify {
            justify-content: space-between;
        }
        
        label {
            color: #718096;
            font-size: 14px;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        input, select, textarea {
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        textarea {
            min-height: 100%;
            resize: vertical;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        
        .checkbox-group input[type="checkbox"] {
            margin-right: 8px;
            width: 18px;
            height: 18px;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }
        
        button {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .output-section {
            margin-top: 30px;
            padding: 20px;
            background: #f7fafc;
            border-radius: 10px;
        }
        
        .output-section h3 {
            color: #4a5568;
            margin-bottom: 15px;
        }
        
        #qrcode {
            display: flex;
            justify-content: center;
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 10px;
        }
        
        .data-display {
            background: #2d3748;
            color: #68d391;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            word-break: break-all;
            margin: 10px 0;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            font-size: 12px;
            color: #718096;
            margin-top: 5px;
        }
        
        .injury-section {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin: 20px 0;
        }
        
        .body-diagram {
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            min-height: 200px;
            background: #f7fafc;
        }
        
        .treatment-checklist {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        /* æ–°å¢æ”å½±æ©Ÿç•«é¢æ¨£å¼ */
        #videoContainer {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        #video {
            width: 80%;
            max-width: 640px;
            height: auto;
            border: 2px solid white;
            background: #333;
        }
    </style>
</head>
<body>
    <div id="videoContainer" style="display: none;">
        <video id="video"></video>
        <button onclick="stopCamera()" style="margin-top: 20px; background: #e53e3e;">é—œé–‰ç›¸æ©Ÿ</button>
    </div>

    <div class="container">
        <h1>DD Form 1380 TCCC æ•¸ä½ç°½ç«  QR Code ç³»çµ±</h1>
        
        <div class="card">
            <form id="tcccForm">
                <div class="form-section" style="background: #f0f9ff; padding: 20px; border-radius: 10px; margin-bottom: 25px;">
                    <h3 style="text-align: center; color: #0369a1; margin-bottom: 15px;">å¿«é€Ÿæ“ä½œ</h3>
                    <div class="button-group">
                        <button type="button" onclick="startCamera()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                            ğŸ¥ é–‹å•Ÿç›¸æ©Ÿæƒæ
                        </button>
                        <button type="button" onclick="document.getElementById('formFileInput').click()" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
                            ğŸ“‚ ä¸Šå‚³ QR Code åœ–ç‰‡
                        </button>
                        <input type="file" id="formFileInput" accept="image/*" style="display: none;" onchange="handleFileSelect(event)">
                        <button type="button" onclick="loadSampleData()" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                            ğŸ“‹ è¼‰å…¥ç¯„ä¾‹è³‡æ–™
                        </button>
                        <button type="button" id="check-update-btn" onclick="checkForUpdate()" style="background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);">
                            ğŸ”„ æ›´æ–°ç¨‹å¼
                        </button>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3>åŸºæœ¬è³‡è¨Š Basic Information</h3>
                    <div class="form-grid">
                        <div class="form-group form-group-justify">
                            <label>å§“å Name</label>
                            <input type="text" id="name" required>
                        </div>
                        <div class="form-group form-group-justify">
                            <label>è»ç±/èº«ä»½è­‰/è­·ç…§  Mil ID/National ID/Passport</label>
                            <input type="text" id="serviceNumber" required>
                        </div>
                        <div class="form-group form-group-justify">
                            <label>è¡€å‹ Blood Type</label>
                            <select id="bloodType" required>
                                <option value="">é¸æ“‡è¡€å‹</option>
                                <option value="A+">A+</option>
                                <option value="A-">A-</option>
                                <option value="B+">B+</option>
                                <option value="B-">B-</option>
                                <option value="AB+">AB+</option>
                                <option value="AB-">AB-</option>
                                <option value="O+">O+</option>
                                <option value="O-">O-</option>
                            </select>
                        </div>
                        <div class="form-group form-group-justify">
                            <label>éæ•å² Allergies</label>
                            <input type="text" id="allergies" placeholder="ç„¡éæ•è«‹å¡« NKDA">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>å‚·å‹¢è©•ä¼° Injury Assessment</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>å—å‚·æ™‚é–“ Time of Injury</label>
                            <input type="datetime-local" id="injuryTime" required>
                        </div>
                        <div class="form-group">
                            <label>å—å‚·æ©Ÿåˆ¶ Mechanism of Injury</label>
                            <select id="mechanism" required>
                                <option value="">é¸æ“‡</option>
                                <option value="GSW">æ§å‚· GSW</option>
                                <option value="IED">çˆ†ç‚¸ IED</option>
                                <option value="RPG">ç«ç®­å½ˆ RPG</option>
                                <option value="MVC">è»Šç¦ MVC</option>
                                <option value="Fall">å¢œè½ Fall</option>
                                <option value="Other">å…¶ä»– Other</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="injury-section">
                        <div class="form-group">
                            <label>å‚·å‹¢éƒ¨ä½ Injury Location</label>
                            <div class="body-diagram">
                                <p style="color: #718096;">èº«é«”éƒ¨ä½ç¤ºæ„åœ–</p>
                                <div class="treatment-checklist">
                                    <div class="checkbox-group">
                                        <input type="checkbox" id="head" name="injury">
                                        <label for="head">é ­éƒ¨ Head</label>
                                    </div>
                                    <div class="checkbox-group">
                                        <input type="checkbox" id="neck" name="injury">
                                        <label for="neck">é ¸éƒ¨ Neck</label>
                                    </div>
                                    <div class="checkbox-group">
                                        <input type="checkbox" id="chest" name="injury">
                                        <label for="chest">èƒ¸éƒ¨ Chest</label>
                                    </div>
                                    <div class="checkbox-group">
                                        <input type="checkbox" id="abdomen" name="injury">
                                        <label for="abdomen">è…¹éƒ¨ Abdomen</label>
                                    </div>
                                    <div class="checkbox-group">
                                        <input type="checkbox" id="leftArm" name="injury">
                                        <label for="leftArm">å·¦è‡‚ L-Arm</label>
                                    </div>
                                    <div class="checkbox-group">
                                        <input type="checkbox" id="rightArm" name="injury">
                                        <label for="rightArm">å³è‡‚ R-Arm</label>
                                    </div>
                                    <div class="checkbox-group">
                                        <input type="checkbox" id="leftLeg" name="injury">
                                        <label for="leftLeg">å·¦è…¿ L-Leg</label>
                                    </div>
                                    <div class="checkbox-group">
                                        <input type="checkbox" id="rightLeg" name="injury">
                                        <label for="rightLeg">å³è…¿ R-Leg</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>å‚·å‹¢æè¿° Injury Description</label>
                            <textarea id="injuryDescription" placeholder="è©³ç´°æè¿°å‚·å‹¢..."></textarea>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>ç”Ÿå‘½å¾µè±¡ Vital Signs</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>è„ˆæ Pulse (bpm)</label>
                            <input type="number" id="pulse" min="0" max="300">
                        </div>
                        <div class="form-group">
                            <label>è¡€å£“ Blood Pressure (mmHg)</label>
                            <input type="text" id="bloodPressure" placeholder="120/80">
                        </div>
                        <div class="form-group">
                            <label>å‘¼å¸ Respiratory Rate (bpm)</label>
                            <input type="number" id="respRate" min="0" max="60">
                        </div>
                        <div class="form-group">
                            <label>è¡€æ°§ SpO2 (%)</label>
                            <input type="number" id="spo2" min="0" max="100">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>æ²»ç™‚æªæ–½ Treatments</h3>
                    <div class="treatment-checklist">
                        <div class="checkbox-group">
                            <input type="checkbox" id="tourniquet" name="treatment">
                            <label for="tourniquet">æ­¢è¡€å¸¶ Tourniquet</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="chestSeal" name="treatment">
                            <label for="chestSeal">èƒ¸å° Chest Seal</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="npa" name="treatment">
                            <label for="npa">é¼»å’½ç®¡ NPA</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="decompress" name="treatment">
                            <label for="decompress">èƒ¸è…”æ¸›å£“ Needle Decompression</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="iv" name="treatment">
                            <label for="iv">éœè„ˆè¼¸æ¶² IV/IO</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="morphine" name="treatment">
                            <label for="morphine">å—å•¡ Morphine</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="antibiotics" name="treatment">
                            <label for="antibiotics">æŠ—ç”Ÿç´  Antibiotics</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="hypothermia" name="treatment">
                            <label for="hypothermia">ä¿æº« Hypothermia Prevention</label>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-top: 15px;">
                        <label>å…¶ä»–æ²»ç™‚ Other Treatments</label>
                        <textarea id="otherTreatments" placeholder="å…¶ä»–æ²»ç™‚æªæ–½..."></textarea>
                    </div>
                </div>

                <div class="form-section">
                    <h3>å¾Œé€è³‡è¨Š Evacuation Info</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>å¾Œé€å„ªå…ˆç´š Evacuation Priority</label>
                            <select id="evacPriority" required>
                                <option value="">é¸æ“‡</option>
                                <option value="Urgent">ç·Šæ€¥ Urgent</option>
                                <option value="Priority">å„ªå…ˆ Priority</option>
                                <option value="Routine">ä¾‹è¡Œ Routine</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>æ•‘è­·å“¡ Medic Name</label>
                            <input type="text" id="medicName" required>
                        </div>
                    </div>
                </div>

                <div class="button-group">
                    <button type="submit">ç”Ÿæˆ QR Code</button>
                    <button type="button" onclick="clearForm()">æ¸…é™¤è¡¨å–®</button>
                </div>
            </form>
        </div>

        <div class="card output-section" id="outputSection" style="display: none;">
            <h3>ğŸ“Š è™•ç†çµæœ</h3>
            
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="originalSize">0</div>
                    <div class="stat-label">åŸå§‹å¤§å° (bytes)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="compressedSize">0</div>
                    <div class="stat-label">å£“ç¸®å¾Œå¤§å° (bytes)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="compressionRatio">0%</div>
                    <div class="stat-label">å£“ç¸®ç‡</div>
                </div>
            </div>

            <h4 style="margin-top: 20px;">çµæ§‹åŒ–è³‡æ–™ (JSON)</h4>
            <div class="data-display" id="jsonData"></div>
            
            <h4>COSE Sign1 ç°½ç« è³‡æ–™ (Base64URL)</h4>
            <div class="data-display" id="signedData"></div>
            
            <h4>Base45 ç·¨ç¢¼</h4>
            <div class="data-display" id="base45Data"></div>
            
            <h4>QR Code</h4>
            <div id="qrcode"></div>
            
            <div class="button-group">
                <button onclick="downloadQRCode()">ä¸‹è¼‰ QR Code</button>
                <button onclick="verifyData()">é©—è­‰ç°½ç« </button>
            </div>
        </div>

        <div class="card" id="scanResult" style="display: none; margin-top: 20px;">
             <div id="decodedData"></div>
        </div>
    </div>

    </div> <div id="update-notification" style="display: none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: #2d3748; color: white; padding: 15px 25px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 1000; align-items: center;">
        <span style="margin-right: 20px;">æœ‰æ–°ç‰ˆæœ¬å¯ç”¨ï¼</span>
        <button id="update-button" style="background: #667eea; border: none; color: white; padding: 8px 15px; border-radius: 5px; cursor: pointer;">ç«‹å³æ›´æ–°</button>
    </div>

    <div id="version-display" style="position: fixed; bottom: 5px; right: 10px; font-size: 12px; color: rgba(255, 255, 255, 0.5); z-index: 1001;">
        Loading version...
    </div>

    <script>
        // --- START: QR Code æƒæç›¸é—œå‡½å¼ (ä¿æŒä¸è®Š) ---
        let codeReader = null; 

        async function startCamera() {
            try {
                codeReader = new ZXing.BrowserMultiFormatReader();
                const videoInputDevices = await codeReader.listVideoInputDevices();
                
                if (videoInputDevices.length <= 0) throw new Error("æ‰¾ä¸åˆ°æ”å½±æ©Ÿè£ç½®");

                const selectedDeviceId = videoInputDevices[0].deviceId;
                document.getElementById('videoContainer').style.display = 'flex';

                codeReader.decodeFromVideoDevice(selectedDeviceId, 'video', (result, err) => {
                    if (result) {
                        console.log("æ‰¾åˆ° QR Code:", result.text);
                        processQRCode(result.text);
                        stopCamera();
                    }
                    if (err && !(err instanceof ZXing.NotFoundException)) {
                        console.error("è§£ç¢¼éŒ¯èª¤:", err);
                        alert('æƒæç™¼ç”ŸéŒ¯èª¤: ' + err);
                        stopCamera();
                    }
                });
            } catch (error) {
                alert('ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿï¼š' + error.message);
                console.error('Camera error:', error);
                stopCamera();
            }
        }

        function stopCamera() {
            if (codeReader) {
                codeReader.reset();
                codeReader = null;
            }
            document.getElementById('videoContainer').style.display = 'none';
        }

        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            try {
                const codeReaderForFile = new ZXing.BrowserMultiFormatReader();
                const imageUrl = URL.createObjectURL(file);
                const result = await codeReaderForFile.decodeFromImageUrl(imageUrl);
                processQRCode(result.getText());
                URL.revokeObjectURL(imageUrl);
            } catch (error) {
                alert('ç„¡æ³•è®€å– QR Codeï¼š' + error.message);
                console.error('Scan error:', error);
            } finally {
                event.target.value = null;
            }
        }
        // --- END: QR Code æƒæç›¸é—œå‡½å¼ ---

        // --- START: Web Crypto and COSE Sign1 - PURE BINARY FLOW ---

        // è¼”åŠ©å‡½å¼ï¼šString to ArrayBuffer
        function str2ab(str) {
            return new TextEncoder().encode(str);
        }

        // å–å¾—æˆ–ç”¢ç”Ÿæ–°çš„é‡‘é‘°å° (ä¿æŒä¸è®Š)
        async function getOrGenerateKeys() {
            const storedKeys = JSON.parse(sessionStorage.getItem('tcccKeys'));
            if (storedKeys) {
                const privateKey = await crypto.subtle.importKey("jwk", storedKeys.privateKey, { name: "ECDSA", namedCurve: "P-256" }, true, ["sign"]);
                const publicKey = await crypto.subtle.importKey("jwk", storedKeys.publicKey, { name: "ECDSA", namedCurve: "P-256" }, true, ["verify"]);
                return { privateKey, publicKey };
            }
            const keyPair = await crypto.subtle.generateKey({ name: "ECDSA", namedCurve: "P-256" }, true, ["sign", "verify"]);
            const exportedPrivateKey = await crypto.subtle.exportKey("jwk", keyPair.privateKey);
            const exportedPublicKey = await crypto.subtle.exportKey("jwk", keyPair.publicKey);
            sessionStorage.setItem('tcccKeys', JSON.stringify({
                privateKey: exportedPrivateKey,
                publicKey: exportedPublicKey
            }));
            console.log("New key pair generated and stored in sessionStorage.");
            return keyPair;
        }

        // [æ–°ç‰ˆ] å»ºç«‹ COSE Sign1 ç°½ç« ï¼Œå›å‚³ç´”äºŒé€²ä½ Uint8Array
        async function createCOSESign1(payload) {
            const { privateKey } = await getOrGenerateKeys();
            
            const protectedHeader = { alg: -7, kid: "TCCC-2025-001" }; // ES256
            const protectedHeaderBytes = str2ab(JSON.stringify(protectedHeader));
            const payloadBytes = CBOR.encode(payload);

            const sigStructure = new Uint8Array([
                ...str2ab('Signature1'),
                ...protectedHeaderBytes,
                ...payloadBytes
            ]);

            const signature = await crypto.subtle.sign(
                { name: "ECDSA", hash: { name: "SHA-256" } },
                privateKey,
                sigStructure
            );
            
            // å»ºç«‹ COSE_Sign1 çµæ§‹: ä¸€å€‹åŒ…å«4å€‹å…ƒç´ çš„ CBOR é™£åˆ—
            // [ protected_header, unprotected_header, payload, signature ]
            const coseSign1Array = [
                protectedHeaderBytes,
                {}, // ç©ºçš„ unprotected header
                payloadBytes,
                new Uint8Array(signature) // signature æ˜¯ ArrayBufferï¼Œéœ€è½‰ç‚º Uint8Array
            ];

            // å°‡æ­¤çµæ§‹ç”¨ CBOR ç·¨ç¢¼æˆæœ€çµ‚çš„ Uint8Array
            return CBOR.encode(coseSign1Array);
        }

        // [æ–°ç‰ˆ] ç¨ç«‹çš„ç°½ç« é©—è­‰è¼”åŠ©å‡½å¼
        async function verifySignature(publicKey, protectedHeaderBytes, payloadBytes, signatureBytes) {
            const sigStructure = new Uint8Array([
                ...str2ab('Signature1'),
                ...protectedHeaderBytes,
                ...payloadBytes
            ]);

            return await crypto.subtle.verify(
                { name: "ECDSA", hash: { name: "SHA-256" } },
                publicKey,
                signatureBytes,
                sigStructure
            );
        }
        // --- END: Web Crypto and COSE Sign1 ---

        // --- Base45 and Form Logic (å¤§éƒ¨åˆ†ä¸è®Š) ---
        const BASE45_ALPHABET = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ $%*+-./:";
        function base45Encode(buffer) {
            const bytes = new Uint8Array(buffer);
            let result = '';
            for (let i = 0; i < bytes.length; i += 2) {
                if (i + 1 < bytes.length) {
                    const value = bytes[i] + bytes[i + 1] * 256;
                    result += BASE45_ALPHABET[value % 45] + BASE45_ALPHABET[Math.floor(value / 45) % 45] + BASE45_ALPHABET[Math.floor(value / (45 * 45))];
                } else {
                    const value = bytes[i];
                    result += BASE45_ALPHABET[value % 45] + BASE45_ALPHABET[Math.floor(value / 45)];
                }
            }
            return result;
        }
        function base45Decode(str) {
            const result = [];
            for (let i = 0; i < str.length; i += 3) {
                if (i + 2 < str.length) {
                    const value = BASE45_ALPHABET.indexOf(str[i]) + BASE45_ALPHABET.indexOf(str[i + 1]) * 45 + BASE45_ALPHABET.indexOf(str[i + 2]) * 45 * 45;
                    result.push(value % 256, Math.floor(value / 256));
                } else if (i + 1 < str.length) {
                    const value = BASE45_ALPHABET.indexOf(str[i]) + BASE45_ALPHABET.indexOf(str[i + 1]) * 45;
                    result.push(value);
                }
            }
            return new Uint8Array(result);
        }
        function collectFormData() {
            const injuries = Array.from(document.querySelectorAll('input[name="injury"]:checked')).map(cb => cb.id);
            const treatments = Array.from(document.querySelectorAll('input[name="treatment"]:checked')).map(cb => cb.id);
            return {
                version: "1.0",
                timestamp: new Date().toISOString(),
                patient: { name: document.getElementById('name').value, serviceNumber: document.getElementById('serviceNumber').value, bloodType: document.getElementById('bloodType').value, allergies: document.getElementById('allergies').value || "NKDA" },
                injury: { time: document.getElementById('injuryTime').value, mechanism: document.getElementById('mechanism').value, locations: injuries, description: document.getElementById('injuryDescription').value },
                vitals: { pulse: parseInt(document.getElementById('pulse').value) || null, bloodPressure: document.getElementById('bloodPressure').value || null, respRate: parseInt(document.getElementById('respRate').value) || null, spo2: parseInt(document.getElementById('spo2').value) || null },
                treatments: { applied: treatments, other: document.getElementById('otherTreatments').value },
                evacuation: { priority: document.getElementById('evacPriority').value, medicName: document.getElementById('medicName').value }
            };
        }
        
        // [æ–°ç‰ˆ] è¡¨å–®æäº¤æµç¨‹
        document.getElementById('tcccForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const tcccData = collectFormData();
            const jsonString = JSON.stringify(tcccData);
            const originalSize = new TextEncoder().encode(jsonString).length;
            
            // 1. å»ºç«‹ç´”äºŒé€²ä½çš„ COSE_Sign1 ç‰©ä»¶
            const coseSign1Bytes = await createCOSESign1(tcccData);
            
            // 2. ç›´æ¥å£“ç¸®æ­¤äºŒé€²ä½ç‰©ä»¶
            const compressed = pako.deflate(coseSign1Bytes);
            const compressedSize = compressed.length;
            
            // 3. Base45 ç·¨ç¢¼
            const base45Encoded = base45Encode(compressed);
            const qrData = "TC1:" + base45Encoded;
            
            // --- æ›´æ–°é¡¯ç¤º ---
            document.getElementById('outputSection').style.display = 'block';
            document.getElementById('jsonData').textContent = jsonString;
            // å› ç‚ºæ˜¯äºŒé€²ä½ï¼ŒsignedData å€å¡Šé¡¯ç¤ºæç¤ºè¨Šæ¯
            document.getElementById('signedData').textContent = `[Binary COSE_Sign1 Data - ${coseSign1Bytes.byteLength} bytes]`;
            document.getElementById('base45Data').textContent = qrData;
            document.getElementById('originalSize').textContent = originalSize;
            document.getElementById('compressedSize').textContent = compressedSize;
            document.getElementById('compressionRatio').textContent = Math.round((1 - compressedSize / originalSize) * 100) + '%';
            
            document.getElementById('qrcode').innerHTML = '';
            new QRCode(document.getElementById('qrcode'), {
                text: qrData, width: 300, height: 300,
                colorDark: "#000000", colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.M,
                margin: 4
            });
            document.getElementById('outputSection').scrollIntoView({ behavior: 'smooth' });
        });
        
        function clearForm() {
            if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿ')) {
                document.getElementById('tcccForm').reset();
                document.getElementById('outputSection').style.display = 'none';
            }
        }
        
        function downloadQRCode() {
            const canvas = document.querySelector('#qrcode canvas');
            if (canvas) {
                const link = document.createElement('a');
                link.download = 'TCCC_QRCode_' + new Date().getTime() + '.png';
                link.href = canvas.toDataURL();
                link.click();
            }
        }
        
        // [æ–°ç‰ˆ] é©—è­‰è³‡æ–™æµç¨‹
        async function verifyData() {
            const base45Data = document.getElementById('base45Data').textContent;
            try {
                // 1. Base45 è§£ç¢¼ -> 2. Zlib è§£å£“ç¸® -> å¾—åˆ°ç´”äºŒé€²ä½ COSE_Sign1 ç‰©ä»¶
                const decompressedBytes = pako.inflate(base45Decode(base45Data.replace('TC1:', '')));
                
                // 3. CBOR è§£ç¢¼ COSE_Sign1 çµæ§‹
                const coseSign1Array = CBOR.decode(decompressedBytes);
                const [protectedHeaderBytes, , payloadBytes, signatureBytes] = coseSign1Array;
                
                // 4. é©—è­‰ç°½ç« 
                const { publicKey } = await getOrGenerateKeys();
                const isValid = await verifySignature(publicKey, protectedHeaderBytes, payloadBytes, signatureBytes);

                if (isValid) {
                    // 5. CBOR è§£ç¢¼ payload å–å¾—åŸå§‹è³‡æ–™
                    const payload = CBOR.decode(payloadBytes);
                    alert('âœ… ç°½ç« é©—è­‰æˆåŠŸï¼\n\nè³‡æ–™å®Œæ•´æ€§å·²ç¢ºèªã€‚');
                    console.log('é©—è­‰çš„è³‡æ–™:', payload);
                } else {
                    alert('âŒ ç°½ç« é©—è­‰å¤±æ•—ï¼\n\nSignature is invalid.');
                }
            } catch (error) {
                alert('âŒ è³‡æ–™è§£æå¤±æ•—ï¼\n\n' + error.message);
                console.error(error);
            }
        }
        
        // [æ–°ç‰ˆ] è™•ç† QR Code æµç¨‹
        async function processQRCode(qrData) {
            try {
                if (!qrData.startsWith('TC1:')) throw new Error('é€™ä¸æ˜¯æœ‰æ•ˆçš„ TCCC QR Code');
                
                const decompressedBytes = pako.inflate(base45Decode(qrData.replace('TC1:', '')));
                const coseSign1Array = CBOR.decode(decompressedBytes);
                const [protectedHeaderBytes, , payloadBytes, signatureBytes] = coseSign1Array;

                const { publicKey } = await getOrGenerateKeys();
                const isValid = await verifySignature(publicKey, protectedHeaderBytes, payloadBytes, signatureBytes);

                if (isValid) {
                    const payload = CBOR.decode(payloadBytes);
                    alert('âœ… QR Code è®€å–èˆ‡é©—è­‰æˆåŠŸï¼');
                    displayDecodedData(payload);
                    fillFormFromData(payload);
                } else {
                    throw new Error('ç°½ç« é©—è­‰å¤±æ•—');
                }
            } catch (error) {
                alert('QR Code è§£æå¤±æ•—ï¼š' + error.message);
                console.error('Process error:', error);
            }
        }

        // --- Display and Form Fill Logic (ä¿æŒä¸è®Š) ---
        function displayDecodedData(data) {
            const scanResult = document.getElementById('scanResult');
            const decodedData = document.getElementById('decodedData');
            let html = `<div class="patient-card"><div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;"><h3 style="margin: 0;">æƒæçµæœï¼šå‚·æ‚£è³‡è¨Š</h3><span style="padding: 5px 10px; border-radius: 15px; color: white; background-color: ${data.evacuation.priority.toLowerCase() === 'urgent' ? '#e53e3e' : '#f59e0b'};">${data.evacuation.priority}</span></div><p><strong>å§“å:</strong> ${data.patient.name} | <strong>è»ç±/èº«ä»½è­‰/è­·ç…§:</strong> ${data.patient.serviceNumber}</p><p><strong>è¡€å‹:</strong> ${data.patient.bloodType} | <strong>éæ•å²:</strong> ${data.patient.allergies}</p><hr style="margin: 10px 0;"><p><strong>å—å‚·æ™‚é–“:</strong> ${new Date(data.injury.time).toLocaleString('zh-TW', { timeZone: 'Asia/Taipei' })}</p><p><strong>å—å‚·æ©Ÿåˆ¶:</strong> ${data.injury.mechanism}</p><p><strong>å—å‚·éƒ¨ä½:</strong> ${data.injury.locations.join(', ')}</p><p><strong>å·²å¯¦æ–½æ²»ç™‚:</strong> ${data.treatments.applied.join(', ') || 'ç„¡'}</p><hr style="margin: 10px 0;"><p><strong>æ•‘è­·å“¡:</strong> ${data.evacuation.medicName} | <strong>è¨˜éŒ„æ™‚é–“:</strong> ${new Date(data.timestamp).toLocaleString('zh-TW', { timeZone: 'Asia/Taipei' })}</p></div>`;
            decodedData.innerHTML = html;
            scanResult.style.display = 'block';
            scanResult.scrollIntoView({ behavior: 'smooth' });
        }
        function fillFormFromData(data) {
            document.getElementById('name').value = data.patient.name || '';
            document.getElementById('serviceNumber').value = data.patient.serviceNumber || '';
            document.getElementById('bloodType').value = data.patient.bloodType || '';
            document.getElementById('allergies').value = data.patient.allergies || '';
            document.getElementById('injuryTime').value = data.injury.time || '';
            document.getElementById('mechanism').value = data.injury.mechanism || '';
            document.getElementById('injuryDescription').value = data.injury.description || '';
            document.querySelectorAll('input[name="injury"]').forEach(cb => cb.checked = false);
            data.injury.locations.forEach(location => {
                const cb = document.getElementById(location);
                if (cb) cb.checked = true;
            });
            document.getElementById('pulse').value = data.vitals.pulse || '';
            document.getElementById('bloodPressure').value = data.vitals.bloodPressure || '';
            document.getElementById('respRate').value = data.vitals.respRate || '';
            document.getElementById('spo2').value = data.vitals.spo2 || '';
            document.querySelectorAll('input[name="treatment"]').forEach(cb => cb.checked = false);
            data.treatments.applied.forEach(treatment => {
                const cb = document.getElementById(treatment);
                if (cb) cb.checked = true;
            });
            document.getElementById('otherTreatments').value = data.treatments.other || '';
            document.getElementById('evacPriority').value = data.evacuation.priority || '';
            document.getElementById('medicName').value = data.evacuation.medicName || '';
        }
        function loadSampleData() {
            const sampleData = {
                name: 'ç‹å¤§æ˜', serviceNumber: 'TW-2024-0001', bloodType: 'O+',
                allergies: 'Penicillin', injuryTime: new Date().toISOString().slice(0, 16),
                mechanism: 'IED', injuryDescription: 'å³ä¸‹è‚¢çˆ†ç‚¸å‚·ï¼Œå¤§é‡å‡ºè¡€',
                pulse: '120', bloodPressure: '90/60', respRate: '24', spo2: '92',
                evacPriority: 'Urgent', medicName: 'æé†«å®˜'
            };
            for (const key in sampleData) {
                document.getElementById(key).value = sampleData[key];
            }
            document.getElementById('rightLeg').checked = true;
            document.getElementById('tourniquet').checked = true;
            document.getElementById('iv').checked = true;
            document.getElementById('morphine').checked = true;
            alert('âœ… ç¯„ä¾‹è³‡æ–™å·²è¼‰å…¥ï¼æ‚¨å¯ä»¥ç›´æ¥ç”Ÿæˆ QR Code æ¸¬è©¦ã€‚');
        }

        // è¨­å®šé è¨­æ™‚é–“ç‚ºç¾åœ¨
        document.getElementById('injuryTime').value = new Date(new Date().getTime() - new Date().getTimezoneOffset() * 60000).toISOString().slice(0, 16);

        // === ä½¿ç”¨é€™æ®µæ–°çš„ã€å®Œæ•´çš„ Service Worker è¨»å†Šèˆ‡æ›´æ–°é‚è¼¯ ===
        let swRegistration = null; // ç”¨æ–¼å„²å­˜ Service Worker çš„è¨»å†Šç‰©ä»¶
        let currentVersion = 'unknown';
        let newWorkerVersion = 'unknown';

        // é¡¯ç¤ºæ›´æ–°æ©«å¹…çš„å‡½å¼
        function showUpdateBanner(registration, oldVerName, newVerName) {
            const notification = document.getElementById('update-notification');
            const updateButton = document.getElementById('update-button');
            const notificationSpan = notification.querySelector('span');

            const oldVerDisplay = oldVerName.split('-').pop() || 'unknown';
            const newVerDisplay = newVerName.split('-').pop() || 'unknown';

            notificationSpan.textContent = `æœ‰æ–°ç‰ˆæœ¬å¯ç”¨ï¼(ç•¶å‰: ${oldVerDisplay}, æ–°ç‰ˆ: ${newVerDisplay})`;
            notification.style.display = 'flex';

            // ç§»é™¤èˆŠçš„äº‹ä»¶ç›£è½å™¨ä»¥é¿å…é‡è¤‡è¨»å†Š
            updateButton.onclick = null; 
            updateButton.addEventListener('click', () => {
                const waitingWorker = registration.waiting;
                if (waitingWorker) {
                    waitingWorker.postMessage({ action: 'SKIP_WAITING' });
                    notification.style.display = 'none';
                }
            }, { once: true }); // ä½¿ç”¨ once: true ç¢ºä¿äº‹ä»¶åªåŸ·è¡Œä¸€æ¬¡
        }

        // æª¢æŸ¥æ›´æ–°çš„å‡½å¼ (ç”±æŒ‰éˆ•è§¸ç™¼)
        async function checkForUpdate() {
            // alert('æ­£åœ¨æª¢æŸ¥æ›´æ–°...');
            
            try {
                let registration = await navigator.serviceWorker.getRegistration();

                if (!registration) {
                    console.warn('Service Worker å°šæœªè¨»å†Šæˆ–å·²å¸è¼‰ï¼Œå˜—è©¦é‡æ–°è¨»å†Šã€‚');
                    registration = await navigator.serviceWorker.register('./sw.js');
                }

                // å˜—è©¦æ›´æ–° Service Worker
                // await registration.update();

                // å†æ¬¡ç²å–æœ€æ–°çš„è¨»å†Šç‰©ä»¶ï¼Œå› ç‚º update() å¯èƒ½æœƒæ”¹è®Šå®ƒçš„ç‹€æ…‹
                const updatedRegistration = await navigator.serviceWorker.getRegistration();

                if (updatedRegistration && updatedRegistration.waiting) {
                    console.log("ç™¼ç¾ç­‰å¾…ä¸­çš„æ–°ç‰ˆæœ¬ Service Workerã€‚");
                    updatedRegistration.waiting.postMessage({ action: 'GET_VERSION', fromUpdateCheck: true });
                } else {
                    alert(`æ‚¨ç›®å‰ä½¿ç”¨çš„å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ (${currentVersion.split('-').pop() || 'unknown'})ã€‚`);
                }
            } catch (error) {
                console.error('Error during update check:', error);
                
                // --- ç‰¹æ®Šè™•ç† InvalidStateError ---
                if (error.name === 'InvalidStateError') {
                    console.warn('æ•ç²åˆ° InvalidStateErrorï¼Œå¯èƒ½ç”±æ–¼ Service Worker è™•æ–¼ä¸ç©©å®šç‹€æ…‹ã€‚');
                    alert('Service Worker ç‹€æ…‹ç•°å¸¸ï¼Œå˜—è©¦å¼·åˆ¶æ›´æ–°ã€‚é€™å°‡é‡æ–°è¼‰å…¥é é¢ã€‚');
                    
                    // åœ¨æ­¤æƒ…æ³ä¸‹ï¼Œæˆ‘å€‘å°‡å˜—è©¦æ›´æ¿€é€²åœ°é‡ç½® Service Worker ç‹€æ…‹
                    // é€é window.location.reload() ä¾†å¼·åˆ¶ç€è¦½å™¨é‡æ–°æª¢æŸ¥æ‰€æœ‰å…§å®¹
                    // ä¸¦å¸Œæœ›åœ¨é‡æ–°è¼‰å…¥æ™‚ï¼ŒService Worker èƒ½æ­£å¸¸å®‰è£å’Œå•Ÿç”¨
                    window.location.reload(true); // å‚³é true åƒæ•¸è¡¨ç¤ºå¾ä¼ºæœå™¨é‡æ–°ç²å–
                } else {
                    alert('æª¢æŸ¥æ›´æ–°å¤±æ•—ï¼š' + error.message);
                }
            }
        }


        if ('serviceWorker' in navigator) {
            // ç›£è½ä¾†è‡ª SW çš„è¨Šæ¯ (åŒ…å«ç‰ˆæœ¬å›è¦†)
            navigator.serviceWorker.addEventListener('message', event => {
                if (event.data && event.data.type === 'VERSION') {
                    const versionDisplayElement = document.getElementById('version-display');
                    const newVersionDisplay = event.data.version.split('-').pop() || 'unknown';
                    
                    // å¦‚æœæ˜¯ä¾†è‡ªæ›´æ–°æª¢æŸ¥çš„å›è¦†ï¼Œä¸”æœ‰ç­‰å¾…ä¸­çš„ worker
                    if (event.data.action === 'GET_VERSION_RESPONSE_FOR_UPDATE_CHECK' && swRegistration.waiting) {
                        // é€™å€‹ç‰ˆæœ¬æ˜¯æ–° worker çš„ç‰ˆæœ¬
                        newWorkerVersion = event.data.version;
                        // é¡¯ç¤ºæ›´æ–°æ©«å¹…ï¼Œå‚³å…¥èˆŠç‰ˆæœ¬å’Œæ–°ç‰ˆæœ¬
                        showUpdateBanner(swRegistration, currentVersion, newWorkerVersion);
                    } else {
                        // é€™æ˜¯é é¢è¼‰å…¥æ™‚çš„åˆå§‹ç‰ˆæœ¬æŸ¥è©¢ï¼Œè¨­å®šç‚º currentVersion
                        currentVersion = event.data.version;
                        versionDisplayElement.textContent = `Ver: ${newVersionDisplay}`;
                    }
                }
            });

            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        swRegistration = registration;
                        console.log('Service Worker registered with scope: ', registration.scope);

                        // é¦–æ¬¡è¼‰å…¥æ™‚ï¼Œå¦‚æœå·²æœ‰ active çš„ SWï¼Œå°±å‘å®ƒè«‹æ±‚ç•¶å‰ç‰ˆæœ¬è™Ÿ
                        if (registration.active) {
                            registration.active.postMessage({ action: 'GET_VERSION' });
                        }
                        
                        // ç›£è½æ˜¯å¦æœ‰æ–°ç‰ˆæœ¬å®‰è£å®Œç•¢ä¸¦é€²å…¥ç­‰å¾…ç‹€æ…‹
                        registration.addEventListener('updatefound', () => {
                            const installingWorker = registration.installing;
                            if (installingWorker) {
                                installingWorker.addEventListener('statechange', () => {
                                    if (installingWorker.state === 'installed' && swRegistration.waiting) {
                                        // æ–° worker å·²å®‰è£ï¼Œä½†å°šæœªå•Ÿç”¨ (ç­‰å¾…ä¸­)
                                        // å‘é€™å€‹æ–°çš„ waiting worker è«‹æ±‚å®ƒçš„ç‰ˆæœ¬è™Ÿï¼Œç„¶å¾Œè§¸ç™¼æ©«å¹…é¡¯ç¤º
                                        installingWorker.postMessage({ action: 'GET_VERSION', fromUpdateCheck: true });
                                    }
                                });
                            }
                        });
                    }).catch(error => {
                        console.log('Service Worker registration failed: ', error);
                    });

                // ç›£è½ Service Worker æ§åˆ¶å™¨è®Šæ›´äº‹ä»¶
                // ç•¶æ–°çš„ Service Worker æ¥ç®¡é é¢æ§åˆ¶æ¬Šæ™‚è§¸ç™¼
                let refreshing = false;
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    if (refreshing) return; // é˜²æ­¢é‡è¤‡é‡æ–°æ•´ç†
                    refreshing = true;
                    // ç•¶æ–°çš„ Service Worker æˆç‚º active çš„æ§åˆ¶å™¨å¾Œï¼Œé‡æ–°è¼‰å…¥é é¢
                    window.location.reload(); 
                });
            });
        }
    </script>

</body>
</html>